# 在线模式优化说明

## 优化内容

### 1. 搜索参数记忆功能

在线模式的搜索提交记录功能现在会自动记住用户输入的搜索参数。

#### 实现方式

使用浏览器的 `localStorage` 保存和加载搜索参数：

- **保存时机：** 点击"搜索"按钮时
- **保存内容：**
  - 目录路径 (`search_path`)
  - 关键词 (`search_keyword`)
  - 作者 (`search_author`)

- **加载时机：** 页面加载并成功加载配置文件后
- **加载位置：** `loadSearchParams()` 函数

#### 使用效果

1. 用户首次输入搜索条件并搜索
2. 刷新页面或下次访问时，搜索框会自动填充上次的搜索条件
3. 用户可以直接点击"搜索"或修改后再搜索

#### 代码实现

```javascript
// 保存搜索参数
function searchLogs() {
    const path = document.getElementById('searchPath').value;
    const keyword = document.getElementById('searchKeyword').value;
    const author = document.getElementById('searchAuthor').value;
    
    // 保存到 localStorage
    localStorage.setItem('search_path', path);
    localStorage.setItem('search_keyword', keyword);
    localStorage.setItem('search_author', author);
    
    // ... 执行搜索
}

// 加载搜索参数
function loadSearchParams() {
    const path = localStorage.getItem('search_path');
    const keyword = localStorage.getItem('search_keyword');
    const author = localStorage.getItem('search_author');
    
    if (path) document.getElementById('searchPath').value = path;
    if (keyword) document.getElementById('searchKeyword').value = keyword;
    if (author) document.getElementById('searchAuthor').value = author;
}
```

### 2. 文件列表全选复选框状态修复

修复了变更文件列表中全选复选框状态不匹配的问题。

#### 问题描述

- 加载文件列表时，默认所有文件都被选中（`selectedFileIndices` 包含所有文件）
- 但是标题栏的全选复选框没有被勾选
- 导致视觉上的不一致

#### 解决方案

添加了 `updateSelectAllFilesCheckbox()` 函数，在以下时机更新全选复选框状态：

1. **渲染文件列表后** (`renderFiles()`)
2. **切换单个文件选择后** (`toggleFile()`)

#### 代码实现

```javascript
function updateSelectAllFilesCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllFiles');
    if (selectAllCheckbox && files.length > 0) {
        const allSelected = files.every(f => selectedFileIndices.has(f.index));
        selectAllCheckbox.checked = allSelected;
    }
}

function renderFiles() {
    // ... 渲染文件列表
    
    // 更新全选复选框状态
    updateSelectAllFilesCheckbox();
}

function toggleFile(index) {
    if (selectedFileIndices.has(index)) {
        selectedFileIndices.delete(index);
    } else {
        selectedFileIndices.add(index);
    }
    // 更新全选复选框状态
    updateSelectAllFilesCheckbox();
}
```

#### 逻辑说明

- 使用 `Array.every()` 检查是否所有文件都在 `selectedFileIndices` 中
- 如果所有文件都被选中，全选复选框显示为勾选状态
- 如果有任何文件未被选中，全选复选框显示为未勾选状态

## 用户体验改进

### 搜索参数记忆

**优势：**
- ✅ 减少重复输入
- ✅ 提高工作效率
- ✅ 适合频繁搜索同一项目或作者的场景
- ✅ 参数持久化，关闭浏览器后仍然保留

**使用场景：**
- 经常审核同一个目录的代码
- 经常搜索特定作者的提交
- 经常使用相同的关键词过滤

### 全选复选框状态修复

**优势：**
- ✅ 视觉反馈准确
- ✅ 避免用户困惑
- ✅ 符合用户预期
- ✅ 提升界面一致性

**修复前：**
- 所有文件已选中，但全选框未勾选 ❌
- 用户可能误以为没有选中任何文件

**修复后：**
- 所有文件已选中，全选框也勾选 ✅
- 状态一致，用户体验更好

## 技术细节

### localStorage 使用

- **存储位置：** 浏览器本地存储
- **作用域：** 同源策略（同协议、域名、端口）
- **持久性：** 永久保存，除非手动清除
- **容量限制：** 通常 5-10MB

### 状态同步

全选复选框状态与文件选择状态保持同步：

```
selectedFileIndices (Set) ←→ 全选复选框 (checked)
         ↕
    文件列表复选框 (checked)
```

## 注意事项

1. **localStorage 清除：** 用户清除浏览器数据会丢失保存的参数
2. **隐私模式：** 隐私/无痕模式下 localStorage 可能不可用
3. **跨浏览器：** 不同浏览器的 localStorage 是独立的
4. **数据验证：** 从 localStorage 读取的数据应该进行验证（当前实现已包含）

## 测试建议

### 搜索参数记忆测试

1. 输入搜索条件并搜索
2. 刷新页面，检查搜索框是否自动填充
3. 修改搜索条件再搜索
4. 再次刷新，检查是否保存了最新的搜索条件
5. 清除浏览器数据，检查搜索框是否为空

### 全选复选框测试

1. 加载文件列表，检查全选框是否勾选（默认全选）
2. 取消选择一个文件，检查全选框是否自动取消勾选
3. 手动勾选所有文件，检查全选框是否自动勾选
4. 点击全选框取消，检查所有文件是否取消选择
5. 点击全选框勾选，检查所有文件是否被选中
