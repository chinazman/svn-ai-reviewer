# 更新说明 - 源代码模式

## 版本信息

- **版本号**: v1.1.0
- **发布日期**: 2025-11-07
- **更新类型**: 功能新增

## 更新概述

新增"源代码模式"，允许用户直接输入目录或文件路径，通过过滤条件筛选文件，然后选择需要审核的文件进行AI代码审核。

## 主要变更

### 新增功能

1. **源代码模式页面** (`/source`)
   - 全新的审核模式界面
   - 与本地模式、在线模式并列

2. **文件扫描功能**
   - 支持输入单个文件路径
   - 支持输入目录路径（递归扫描）
   - 支持通配符过滤（`*.go`、`src/*.js` 等）

3. **本地记忆功能**
   - 自动保存输入的路径和过滤条件
   - 使用 localStorage 实现
   - 下次打开自动恢复

4. **文件选择优化**
   - 默认不勾选文件（与本地/在线模式不同）
   - 支持全选/取消全选
   - 支持文件内容预览

### 新增文件

```
cmd/
  source.go                      # 源代码模式命令

gui/
  templates/
    source.html                  # 源代码模式页面

文档/
  源代码模式使用说明.md           # 完整使用说明
  源代码模式快速测试.md           # 快速测试指南
  更新说明-源代码模式.md          # 本文件
```

### 修改文件

```
gui/server.go                    # 新增源代码模式处理函数
gui/templates/index.html         # 添加源代码模式按钮
gui/templates/online.html        # 添加源代码模式按钮
README.md                        # 更新功能说明
功能清单.md                      # 更新功能列表
```

### 新增API接口

- `GET /source` - 源代码模式页面
- `POST /api/source/scan` - 扫描文件
- `POST /api/source/content` - 获取文件内容
- `POST /api/source/review` - 执行审核

## 技术实现

### 后端实现

1. **Server结构扩展**
   ```go
   type SourceFile struct {
       Index int
       Path  string
   }
   ```

2. **文件扫描函数**
   - `scanSourceFiles()` - 递归扫描目录
   - `matchFilter()` - 通配符匹配

3. **处理函数**
   - `handleSourceIndex()` - 页面渲染
   - `handleSourceScan()` - 文件扫描
   - `handleSourceContent()` - 内容查看
   - `handleSourceReview()` - 执行审核

### 前端实现

1. **输入保存**
   ```javascript
   localStorage.setItem('source_path', path);
   localStorage.setItem('source_filter', filter);
   ```

2. **默认不勾选**
   ```javascript
   selectedFileIndices.clear();  // 扫描后清空选择
   ```

3. **文件预览**
   - 模态框显示文件内容
   - 支持代码高亮显示

## 使用示例

### 场景1：审核整个项目的Go文件

```
路径：.
过滤：*.go
```

### 场景2：审核特定目录

```
路径：internal/ai
过滤：*.go
```

### 场景3：审核单个文件

```
路径：main.go
过滤：（留空）
```

## 兼容性

- ✅ 完全向后兼容
- ✅ 不影响现有的本地模式和在线模式
- ✅ 使用相同的配置文件
- ✅ 使用相同的报告格式
- ✅ 使用相同的AI客户端

## 升级指南

### 从旧版本升级

1. 重新编译：
   ```bash
   go build -o svn-ai-reviewer.exe
   ```

2. 无需修改配置文件

3. 启动服务后访问新模式：
   ```
   http://localhost:8080/source
   ```

### 配置要求

无需额外配置，使用现有的 `config.yaml` 即可。

## 测试建议

1. **基本功能测试**
   - 扫描当前目录
   - 扫描子目录
   - 扫描单个文件

2. **过滤功能测试**
   - 测试 `*.go`
   - 测试 `src/*.js`
   - 测试多级路径匹配

3. **记忆功能测试**
   - 输入后刷新页面
   - 验证内容恢复

4. **审核功能测试**
   - 选择文件审核
   - 查看报告

详细测试步骤请参考 `源代码模式快速测试.md`。

## 已知限制

1. **文件数量**
   - 建议单次审核不超过100个文件
   - 大量文件可能导致扫描时间较长

2. **文件类型**
   - 仅支持文本文件
   - 二进制文件可能导致错误

3. **路径格式**
   - Windows和Linux路径格式都支持
   - 建议使用相对路径

## 后续计划

### 短期计划
- [ ] 添加文件大小限制
- [ ] 添加文件编码检测
- [ ] 优化大量文件的扫描性能

### 长期计划
- [ ] 支持正则表达式过滤
- [ ] 支持排除规则
- [ ] 支持保存扫描配置
- [ ] 支持批量审核任务

## 反馈与支持

如有问题或建议，请：
1. 查看 `源代码模式使用说明.md`
2. 查看 `源代码模式快速测试.md`
3. 提交 Issue 或 Pull Request

## 更新日志

### v1.1.0 (2025-11-07)

**新增**
- ✨ 源代码审核模式
- ✨ 文件扫描功能
- ✨ 通配符过滤
- ✨ 本地记忆功能
- ✨ 文件内容预览
- ✨ 默认不勾选文件

**改进**
- 🎨 统一三种模式的界面风格
- 📝 完善文档和使用说明
- 🔧 优化代码结构

**修复**
- 无

---

**感谢使用 SVN 代码审核工具！**
