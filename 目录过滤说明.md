# 目录过滤说明

## 功能说明

在变更列表中自动过滤掉目录，只显示文件。

## 实现方式

### 1. 本地模式（GetChangedFiles）

使用 `os.Stat` 检查路径是否是目录：

```go
// 检查是否是目录（对于非删除的文件）
if status != "D" {
    fullPath := filepath.Join(c.workDir, path)
    if fileInfo, err := os.Stat(fullPath); err == nil && fileInfo.IsDir() {
        // 是目录，跳过
        continue
    }
}
```

**逻辑：**
- 对于非删除状态的文件（A、M、?），检查文件系统
- 如果是目录，跳过不添加到变更列表
- 删除状态（D）的文件无法检查文件系统，但通常SVN不会单独标记目录删除

### 2. 在线模式（GetRevisionFiles）

检查路径是否以 `/` 结尾：

```go
filePath := parts[1]
// 过滤目录：SVN中目录路径通常以 / 结尾
if strings.HasSuffix(filePath, "/") {
    continue
}
```

**逻辑：**
- SVN log的XML输出中，目录路径通常以 `/` 结尾
- 例如：`/trunk/src/` 是目录，`/trunk/src/Main.java` 是文件
- 通过检查路径后缀来过滤目录

## SVN目录标识

### SVN Status输出

```bash
$ svn status
M       src/Main.java          # 文件
A       src/Utils.java         # 文件
A       src/newdir             # 目录（可能没有后缀）
?       build                  # 目录（可能没有后缀）
```

在本地模式中，我们使用文件系统检查来确定是否是目录。

### SVN Log XML输出

```xml
<logentry revision="7">
  <paths>
    <path action="A">/trunk/src/</path>           <!-- 目录，以/结尾 -->
    <path action="A">/trunk/src/Main.java</path>  <!-- 文件 -->
    <path action="M">/trunk/README.md</path>      <!-- 文件 -->
  </paths>
</logentry>
```

在在线模式中，我们检查路径是否以 `/` 结尾。

## 为什么要过滤目录

### 1. 避免混淆
- 目录本身不需要审核
- 只有文件内容才需要审核

### 2. 避免错误
- 对目录执行diff会失败
- 对目录执行审核没有意义

### 3. 清晰的界面
- 用户只看到需要审核的文件
- 减少干扰信息

## 示例

### 本地模式

**过滤前：**
```
检测到 5 个变更:
  [1] [新增] src/newdir
  [2] [新增] src/newdir/Utils.java
  [3] [修改] src/Main.java
  [4] [新增] docs
  [5] [新增] docs/README.md
```

**过滤后：**
```
检测到 3 个变更:
  [1] [新增] src/newdir/Utils.java
  [2] [修改] src/Main.java
  [3] [新增] docs/README.md
```

### 在线模式

**过滤前：**
```
检测到 4 个变更文件:
  [1] [新增] /trunk/src/ (r7)
  [2] [新增] /trunk/src/Utils.java (r7)
  [3] [修改] /trunk/Main.java (r7)
  [4] [新增] /trunk/docs/ (r7)
```

**过滤后：**
```
检测到 2 个变更文件:
  [1] [新增] /trunk/src/Utils.java (r7)
  [2] [修改] /trunk/Main.java (r7)
```

## 边界情况

### 1. 删除的目录
- 本地模式：无法检查文件系统，但SVN通常不单独标记目录删除
- 在线模式：如果路径以 `/` 结尾，会被过滤

### 2. 空目录
- 本地模式：会被 `IsDir()` 检测到并过滤
- 在线模式：如果路径以 `/` 结尾，会被过滤

### 3. 符号链接
- 本地模式：`IsDir()` 会跟随符号链接
- 如果链接指向目录，会被过滤
- 如果链接指向文件，不会被过滤

## 测试场景

### 场景1：新增目录和文件
```bash
mkdir src/newdir
touch src/newdir/Utils.java
svn add src/newdir
```

**预期：** 只显示 `src/newdir/Utils.java`

### 场景2：修改文件
```bash
echo "update" >> src/Main.java
```

**预期：** 显示 `src/Main.java`

### 场景3：删除目录
```bash
svn delete src/olddir
```

**预期：** 不显示目录，只显示目录下的文件（如果有）

## 相关代码

### 修改的函数
- `GetChangedFiles()` - 本地模式，添加目录检查
- `GetRevisionFiles()` - 在线模式，添加路径后缀检查

### 使用的Go函数
- `os.Stat()` - 获取文件信息
- `FileInfo.IsDir()` - 检查是否是目录
- `strings.HasSuffix()` - 检查字符串后缀

## 注意事项

### 1. 性能影响
- 本地模式：每个文件都要调用 `os.Stat()`
- 影响很小，因为通常变更文件不多

### 2. 错误处理
- 如果 `os.Stat()` 失败（文件不存在等），不过滤
- 保守策略：宁可多显示，不要漏掉

### 3. SVN版本兼容性
- 路径以 `/` 结尾是SVN的标准行为
- 适用于所有SVN版本

## 总结

通过两种方式过滤目录：
- ✅ 本地模式：使用文件系统检查
- ✅ 在线模式：检查路径后缀
- ✅ 只显示文件，不显示目录
- ✅ 提供更清晰的用户界面

---

**版本**: 1.5.0  
**更新日期**: 2024-01-15  
**状态**: ✅ 已实现
