# 源代码模式使用说明

## 功能概述

源代码模式是一种新的代码审核方式，允许用户直接输入指定的目录或文件路径，通过过滤条件筛选文件，然后选择需要审核的文件进行AI代码审核。

## 主要特性

1. **灵活的路径输入**
   - 支持输入单个文件路径
   - 支持输入目录路径（自动递归扫描）
   - 路径可以是相对路径或绝对路径

2. **强大的过滤功能**
   - 支持 `*` 号通配符匹配
   - 支持文件名匹配：`*.go`、`*.js`
   - 支持路径匹配：`src/*.go`、`internal/*/*.go`
   - 留空表示匹配所有文件

3. **文件数量限制**
   - 可设置最大文件数量（默认100）
   - 防止扫描过多文件导致页面卡顿
   - 超过限制时会提示并截断
   - 范围：1-1000

4. **本地记忆功能**
   - 自动保存输入的路径和过滤条件
   - 自动保存最大文件数设置
   - 下次打开时自动恢复上次的输入
   - 使用浏览器 localStorage 实现

5. **默认不勾选**
   - 扫描出的文件列表默认不勾选
   - 用户可以手动选择需要审核的文件
   - 支持全选/取消全选功能

## 使用步骤

### 1. 启动服务

```bash
svn-ai-reviewer.exe
```

服务启动后会显示：
```
🚀 SVN 代码审核工具已启动
📱 本地模式: http://localhost:8080
📱 在线模式: http://localhost:8080/online
📱 源代码模式: http://localhost:8080/source
📊 报告目录: http://localhost:8080/reports/
```

### 2. 访问源代码模式

在浏览器中访问：`http://localhost:8080/source`

或者从本地模式/在线模式页面点击"源代码模式"按钮切换。

### 3. 加载配置文件

- 选择配置文件（默认 config.yaml）
- 系统会自动加载AI配置

### 4. 扫描文件

**输入路径：**
- 单个文件：`main.go`
- 当前目录：`.`
- 指定目录：`src`、`internal/ai`
- 绝对路径：`C:\projects\myapp`

**输入过滤条件（默认 *.java）：**
- 所有Java文件：`*.java`（默认）
- 所有Go文件：`*.go`
- 所有JavaScript文件：`*.js`
- src目录下的Java文件：`src/*.java`
- 多级匹配：`internal/*/*.java`

**设置最大文件数（可选）：**
- 默认值：100
- 建议范围：1-1000
- 如果项目文件很多，建议使用更精确的过滤条件

点击"扫描文件"按钮。

### 5. 选择文件

- 扫描完成后，文件列表会显示所有匹配的文件
- 默认所有文件都不勾选
- 手动勾选需要审核的文件
- 可以点击"查看内容"按钮预览文件内容
- 可以使用全选复选框快速选择所有文件

### 6. 开始审核

- 至少选择一个文件
- 点击"开始审核"按钮
- 查看执行日志了解审核进度
- 审核完成后会自动在新标签页打开报告

## 过滤规则说明

### 基本通配符

- `*`：匹配任意字符（不包括路径分隔符）
- `*.go`：匹配所有 .go 文件
- `test_*.js`：匹配所有以 test_ 开头的 .js 文件

### 路径匹配

- `src/*.go`：匹配 src 目录下的所有 .go 文件
- `cmd/*/main.go`：匹配 cmd 目录下任意子目录中的 main.go 文件

### 留空

- 不输入过滤条件：匹配所有文件

## 使用场景

### 场景1：审核特定目录的代码

```
路径：internal/ai
过滤：*.go
```

审核 internal/ai 目录下的所有 Go 文件。

### 场景2：审核单个文件

```
路径：main.go
过滤：（留空）
```

只审核 main.go 文件。

### 场景3：审核整个项目

```
路径：.
过滤：（留空）
```

审核当前目录及所有子目录的所有文件。

### 场景4：审核特定类型文件

```
路径：.
过滤：*.go
```

审核整个项目中的所有 Go 文件。

### 场景5：审核特定模块

```
路径：src
过滤：*.js
```

审核 src 目录下的所有 JavaScript 文件。

## 技术实现

### 前端

- 使用 localStorage 保存用户输入
- 默认不勾选文件列表
- 支持实时日志显示（SSE）
- 自动打开审核报告

### 后端

- 新增 `/api/source/scan` 接口：扫描文件
- 新增 `/api/source/content` 接口：查看文件内容
- 新增 `/api/source/review` 接口：执行审核
- 支持递归目录扫描
- 支持通配符过滤

### 文件结构

```
cmd/
  source.go          # 源代码模式命令
gui/
  server.go          # 服务器处理函数
  templates/
    source.html      # 源代码模式页面
```

## 注意事项

1. **路径安全**：确保输入的路径是可访问的
2. **文件数量限制**：默认最多扫描100个文件，可根据需要调整（1-1000）
3. **过滤精度**：合理使用过滤条件减少不必要的文件
4. **审核成本**：选择文件时考虑AI调用成本
5. **文件编码**：确保文件是文本文件，二进制文件可能导致错误
6. **性能考虑**：如果文件数量超过限制，会自动截断并提示

## 与其他模式的区别

| 特性 | 本地模式 | 在线模式 | 源代码模式 |
|------|---------|---------|-----------|
| 数据源 | SVN本地变更 | SVN服务器历史 | 本地文件系统 |
| 文件选择 | 自动检测变更 | 选择版本号 | 手动指定路径 |
| 过滤方式 | 配置文件 | 关键词搜索 | 通配符匹配 |
| 默认勾选 | 全部勾选 | 全部勾选 | 默认不勾选 |
| 使用场景 | 提交前审核 | 历史代码审核 | 任意代码审核 |

## 常见问题

**Q: 为什么扫描不到文件？**
A: 检查路径是否正确，过滤条件是否过于严格。

**Q: 如何审核整个项目？**
A: 路径输入 `.`，过滤条件留空或输入 `*`。

**Q: 过滤条件不生效？**
A: 确保使用正确的通配符语法，路径分隔符使用 `/`。

**Q: 可以审核非代码文件吗？**
A: 可以，但建议只审核文本文件。

**Q: 输入的路径会保存吗？**
A: 会自动保存在浏览器的 localStorage 中，下次打开自动恢复。

## 更新日志

### v1.0.0 (2025-11-07)

- ✨ 新增源代码模式
- ✨ 支持目录和文件路径输入
- ✨ 支持通配符过滤
- ✨ 本地记忆功能
- ✨ 默认不勾选文件
- ✨ 文件内容预览
- ✨ 实时日志显示
- ✨ 自动打开报告
