# AI请求重试机制说明

## 功能概述

当AI返回的响应不是有效的JSON格式时，系统会自动重试一次请求，以提高审核的成功率。

## 实现细节

### 1. 重试逻辑

- **触发条件**: 当AI返回的内容无法解析为JSON格式时
- **重试次数**: 仅重试1次（避免无限循环）
- **重试范围**: 仅针对单个文件，不影响其他文件的审核

### 2. 代码改动

修改文件: `internal/ai/openai.go`

#### 新增辅助函数

```go
func (c *OpenAIClient) makeRequest(ctx context.Context, jsonData []byte) (string, error)
```

该函数封装了HTTP请求逻辑，便于重试时复用。

#### Review方法改进

1. 首次请求失败时，记录警告信息
2. 自动发起第二次请求
3. 如果第二次请求成功且JSON解析正常，使用新的响应
4. 如果第二次请求仍然失败，使用原始响应继续处理

### 3. 日志输出

重试过程中会输出以下日志：

```
[警告] JSON 解析失败: <错误信息>
[警告] 原始内容: <前200字符>
[信息] 正在重试请求...
[成功] 重试成功，JSON 解析正常
```

或

```
[警告] 重试请求失败: <错误信息>，使用原始响应
[警告] 重试后 JSON 仍然解析失败: <错误信息>，使用原始响应
```

### 4. 错误处理原则

- **不阻断流程**: 即使JSON解析失败，也会继续处理，不影响其他文件
- **单次重试**: 只重试一次，避免循环重试导致的性能问题
- **独立处理**: 每个文件的审核是独立的，一个文件的异常不影响其他文件

## 使用场景

1. AI服务偶尔返回格式错误的响应
2. 网络不稳定导致的响应截断
3. AI模型输出不稳定的情况

## 注意事项

- 重试会增加API调用次数，可能产生额外费用
- 重试仅针对JSON解析失败，不针对网络错误或API错误
- 如果两次请求都失败，系统会继续处理，但可能无法生成完整的审核报告
