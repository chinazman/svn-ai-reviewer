# 报告查看变更功能说明

## 功能概述

在审核报告的每个文件详情中添加了"查看变更"按钮，点击后可以在模态框中查看该文件的完整变更内容（diff）。

## 实现方式

### 1. 数据结构修改 (internal/report/html.go)

在 `FileReview` 和 `FileReviewData` 结构体中添加了新字段：

```go
type FileReview struct {
    FileName string
    Status   string
    Result   *ai.ReviewResult
    Error    error
    Revision int    // SVN版本号（在线模式）
    Diff     string // 变更内容
}
```

### 2. 报告生成修改

#### 后端 (gui/server.go)

**本地模式：**
- 在审核循环中，获取 diff 后保存到 `fileReview.Diff`
- 支持新增、修改、删除等不同状态的文件

**在线模式：**
- 同样保存 diff 内容
- 额外保存 `Revision` 版本号

#### 前端 (internal/report/html.go)

1. **HTML结构：**
   - 在文件头部添加"查看变更"按钮
   - 添加模态框用于显示 diff 内容

2. **样式：**
   - 绿色按钮样式 `.view-diff-btn`
   - 模态框样式 `.modal` 和 `.modal-content`
   - diff 内容显示区域 `.diff-content`

3. **JavaScript功能：**
   - `viewDiff(index)` - 打开模态框显示指定文件的 diff
   - `closeModal()` - 关闭模态框
   - 点击模态框背景也可关闭
   - 文件数据以 JSON 格式嵌入到 HTML 中

## 使用方式

### 在报告中查看变更

1. 打开审核报告（自动在浏览器中打开）
2. 找到要查看的文件
3. 点击文件头部的"查看变更"按钮
4. 在弹出的模态框中查看完整的 diff 内容
5. 点击"关闭"按钮或模态框背景关闭

### 功能特点

- ✅ 无需返回审核页面即可查看变更
- ✅ 支持所有文件状态（新增、修改、删除）
- ✅ diff 内容以等宽字体显示，保持格式
- ✅ 模态框支持滚动查看长内容
- ✅ 点击背景或关闭按钮都可关闭模态框

## 技术细节

### 数据嵌入方式

diff 数据在生成报告时直接嵌入到 HTML 的 JavaScript 中：

```javascript
const fileData = [
    {
        "fileName": "path/to/file.go",
        "status": "M",
        "diff": "--- a/file.go\n+++ b/file.go\n..."
    },
    ...
];
```

### JSON 转义

使用 `escapeJSON()` 函数处理特殊字符：
- 反斜杠 `\` → `\\`
- 双引号 `"` → `\"`
- 换行符 `\n` → `\\n`
- 回车符 `\r` → `\\r`
- 制表符 `\t` → `\\t`

### 样式设计

- 按钮颜色：绿色 (#28a745)，与"查看变更"的功能语义一致
- 模态框：半透明黑色背景，白色内容区域
- diff 内容：灰色背景 (#f4f4f4)，等宽字体，保持代码格式

## 与列表中"查看变更"的区别

### 列表中的"查看变更"
- 位置：在文件列表中
- 功能：实时从服务器获取 diff
- 适用场景：审核前预览变更

### 报告中的"查看变更"
- 位置：在生成的报告中
- 功能：显示报告生成时保存的 diff
- 适用场景：查看历史审核记录
- 优势：离线可用，无需服务器

## 注意事项

1. **报告大小：** diff 内容会增加报告文件大小，特别是对于大文件或多文件审核
2. **浏览器兼容性：** 使用了现代浏览器的 CSS 和 JavaScript 特性
3. **内容限制：** 非常大的 diff 可能影响报告加载速度
4. **编码问题：** 确保 diff 内容正确转义，避免破坏 JSON 格式

## 未来改进方向

- [ ] 添加 diff 语法高亮
- [ ] 支持并排对比视图
- [ ] 添加搜索功能
- [ ] 支持折叠/展开大块变更
- [ ] 添加行号显示
