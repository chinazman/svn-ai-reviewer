# 配置文件选择功能说明

## 功能概述

支持通过下拉框选择不同的配置文件，方便在多个 AI 模型或配置之间快速切换。

## 目录结构

```
svn-reviewer/
├── config.yaml              # 默认配置文件（根目录）
├── config/                  # 配置文件目录
│   ├── deepseek.yaml       # DeepSeek 配置
│   ├── qwen.yaml           # 通义千问配置
│   └── custom.yaml         # 自定义配置
├── reports/                 # 报告输出目录
└── svn-reviewer.exe        # 主程序
```

## 功能特点

### 1. 自动扫描配置文件

**扫描规则：**
- 扫描根目录的 `config.yaml`（如果存在）
- 扫描 `config/` 目录下的所有 `.yaml` 和 `.yml` 文件
- 按文件路径排序显示

**API 端点：**
- `GET /api/list-configs` - 获取配置文件列表

### 2. 下拉框选择

**界面改进：**
- 将原来的文本输入框改为下拉选择框
- 自动填充所有可用的配置文件
- 支持键盘快捷键选择
- 移除了"加载配置"按钮，改为下拉框切换时自动加载

**自动加载：**
- 选择配置文件后立即自动加载
- 无需手动点击按钮
- 提供即时反馈

**默认行为：**
- 如果没有选择，默认使用 `config.yaml`
- 如果 `config.yaml` 不存在，使用列表中的第一个配置

### 3. 记忆功能

**使用 localStorage 保存：**
- 键名：`selected_config`
- 保存时机：点击"加载配置"按钮时
- 加载时机：页面加载时

**持久化：**
- 刷新页面后自动选择上次使用的配置
- 跨会话保持（除非清除浏览器数据）

## 使用方式

### 创建新配置文件

1. 在 `config/` 目录下创建新的 YAML 文件
2. 复制 `config.yaml` 的内容作为模板
3. 修改 AI 配置（provider, api_key, model 等）
4. 刷新页面，新配置会自动出现在下拉框中

### 切换配置

1. 打开审核工具（本地模式或在线模式）
2. 在"配置文件"下拉框中选择要使用的配置
3. 配置会自动加载（无需点击按钮）
4. 系统会记住这次选择，下次自动使用

### 配置文件命名建议

- `deepseek.yaml` - DeepSeek 模型配置
- `qwen.yaml` - 通义千问配置
- `gpt4.yaml` - GPT-4 配置
- `local.yaml` - 本地模型配置
- `test.yaml` - 测试配置

## 实现细节

### 后端实现 (gui/server.go)

#### handleListConfigs 函数

```go
func (s *Server) handleListConfigs(w http.ResponseWriter, r *http.Request) {
    var configs []string

    // 检查根目录的 config.yaml
    if _, err := os.Stat("config.yaml"); err == nil {
        configs = append(configs, "config.yaml")
    }

    // 检查 config 目录下的所有 yaml 文件
    if entries, err := os.ReadDir("config"); err == nil {
        for _, entry := range entries {
            if !entry.IsDir() {
                name := entry.Name()
                if strings.HasSuffix(strings.ToLower(name), ".yaml") || 
                   strings.HasSuffix(strings.ToLower(name), ".yml") {
                    configs = append(configs, "config/"+name)
                }
            }
        }
    }

    respondJSON(w, map[string]interface{}{
        "success": true,
        "configs": configs,
    }, http.StatusOK)
}
```

### 前端实现

#### 加载配置列表

```javascript
async function loadConfigList() {
    try {
        const response = await fetch('/api/list-configs');
        const data = await response.json();
        
        if (data.success && data.configs && data.configs.length > 0) {
            const select = document.getElementById('configPath');
            select.innerHTML = '';
            
            data.configs.forEach(config => {
                const option = document.createElement('option');
                option.value = config;
                option.textContent = config;
                select.appendChild(option);
            });
            
            // 加载保存的配置选择
            const savedConfig = localStorage.getItem('selected_config');
            if (savedConfig && data.configs.includes(savedConfig)) {
                select.value = savedConfig;
            }
        }
    } catch (error) {
        console.error('加载配置列表失败:', error);
    }
}
```

#### 保存配置选择

```javascript
async function loadConfig() {
    const configPath = document.getElementById('configPath').value;
    
    // 保存配置选择
    localStorage.setItem('selected_config', configPath);
    
    // ... 加载配置
}
```

#### 页面加载流程

```javascript
window.onload = async () => {
    await loadConfigList(); // 1. 先加载配置列表
    loadConfig();           // 2. 自动加载选中的配置
    connectLogs();          // 3. 连接日志流
};
```

#### 自动加载配置

```html
<!-- 下拉框添加 onchange 事件 -->
<select id="configPath" onchange="loadConfig()" style="...">
    <option value="config.yaml">config.yaml (默认)</option>
</select>
```

当用户切换下拉框选项时，`onchange` 事件会自动触发 `loadConfig()` 函数。

## 配置文件示例

### DeepSeek 配置 (config/deepseek.yaml)

```yaml
ai:
  provider: "deepseek"
  api_key: "your-deepseek-api-key"
  base_url: "https://api.deepseek.com/v1"
  model: "deepseek-coder"
  temperature: 0.3
  max_tokens: 3000
```

### 通义千问配置 (config/qwen.yaml)

```yaml
ai:
  provider: "openai"
  api_key: "your-qwen-api-key"
  base_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"
  model: "qwen-coder-plus"
  temperature: 0.3
  max_tokens: 3000
```

## 使用场景

### 1. 多模型对比

创建多个配置文件，使用不同的 AI 模型审核同一份代码，对比审核结果。

### 2. 环境隔离

- `config/dev.yaml` - 开发环境配置
- `config/prod.yaml` - 生产环境配置
- `config/test.yaml` - 测试环境配置

### 3. 团队协作

团队成员可以使用各自的 API Key，创建个人配置文件：
- `config/alice.yaml`
- `config/bob.yaml`

### 4. 不同项目

针对不同类型的项目使用不同的审核提示词：
- `config/frontend.yaml` - 前端项目配置
- `config/backend.yaml` - 后端项目配置
- `config/mobile.yaml` - 移动端项目配置

## 注意事项

### 1. 配置文件格式

- 必须是有效的 YAML 格式
- 文件扩展名必须是 `.yaml` 或 `.yml`
- 建议使用 UTF-8 编码

### 2. 安全性

- 不要将包含 API Key 的配置文件提交到版本控制系统
- 建议在 `.gitignore` 中添加：
  ```
  config/*.yaml
  !config/*.example.yaml
  ```

### 3. 配置验证

- 加载配置时会进行格式验证
- 如果配置无效，会显示错误信息
- 建议先用示例配置测试

### 4. 性能考虑

- 配置文件列表在页面加载时获取
- 不会频繁扫描文件系统
- 如果添加新配置，需要刷新页面

## 故障排除

### 配置文件不显示

**可能原因：**
1. 文件扩展名不是 `.yaml` 或 `.yml`
2. 文件不在 `config/` 目录或根目录
3. 文件权限问题

**解决方法：**
1. 检查文件名和扩展名
2. 确认文件位置
3. 检查文件权限

### 配置加载失败

**可能原因：**
1. YAML 格式错误
2. 必需字段缺失
3. API Key 无效

**解决方法：**
1. 使用 YAML 验证工具检查格式
2. 参考示例配置补充字段
3. 检查 API Key 是否正确

### 选择不被记住

**可能原因：**
1. 浏览器禁用了 localStorage
2. 隐私模式/无痕模式
3. 浏览器数据被清除

**解决方法：**
1. 检查浏览器设置
2. 使用普通模式
3. 重新选择配置

## 未来改进

- [ ] 支持配置文件在线编辑
- [ ] 配置文件导入/导出
- [ ] 配置文件模板管理
- [ ] 配置文件版本控制
- [ ] 配置文件加密存储
- [ ] 配置文件热重载
