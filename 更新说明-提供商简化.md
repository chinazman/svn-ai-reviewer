# 更新说明 - AI 提供商简化

## 更新日期
2024-11-04

## 更新内容

### 1. 简化 AI 提供商配置

**变更原因**：
- `openai`、`deepseek`、`custom` 三个提供商使用相同的实现逻辑
- 都基于 OpenAI Chat Completions API 协议
- 保留多个提供商增加了代码复杂度，但没有实际功能差异

**变更内容**：
- 移除 `deepseek` 和 `custom` 提供商
- 统一使用 `openai` 提供商表示 OpenAI 兼容协议
- 通过 `base_url` 配置区分不同的服务

### 2. 新增 DashScope 提供商

**新增功能**：
- 支持阿里云 DashScope 应用级别 API
- 使用应用 ID 而非模型名称
- 支持自定义 base_url

## 配置迁移

### DeepSeek 用户

**旧配置**：
```yaml
ai:
  provider: "deepseek"
  api_key: "sk-..."
  base_url: "https://api.deepseek.com/v1"
  model: "deepseek-coder"
```

**新配置**（只需修改 provider）：
```yaml
ai:
  provider: "openai"
  api_key: "sk-..."
  base_url: "https://api.deepseek.com/v1"
  model: "deepseek-coder"
```

### Custom 提供商用户

**旧配置**：
```yaml
ai:
  provider: "custom"
  api_key: "sk-..."
  base_url: "https://your-api.com/v1"
  model: "your-model"
```

**新配置**（只需修改 provider）：
```yaml
ai:
  provider: "openai"
  api_key: "sk-..."
  base_url: "https://your-api.com/v1"
  model: "your-model"
```

### OpenAI 用户

无需修改，配置保持不变。

## 支持的提供商

### 1. openai - OpenAI 兼容协议

支持所有使用 OpenAI Chat Completions API 协议的服务：
- OpenAI 官方
- DeepSeek
- 通义千问（兼容模式）
- Azure OpenAI
- 本地部署的 LLM（Ollama、LocalAI 等）
- 其他云服务商的兼容 API

### 2. dashscope - 阿里云 DashScope

使用阿里云 DashScope 的应用级别 API：
```yaml
ai:
  provider: "dashscope"
  api_key: "sk-..."
  base_url: "https://dashscope.aliyuncs.com"  # 可选
  model: "YOUR_APP_ID"
```

## 代码变更

### internal/ai/client.go

**变更前**：
```go
switch cfg.Provider {
case "openai", "deepseek", "custom":
    return NewOpenAIClient(cfg), nil
case "dashscope":
    return NewDashScopeClient(cfg), nil
default:
    return nil, fmt.Errorf("不支持的 AI 提供商: %s", cfg.Provider)
}
```

**变更后**：
```go
switch cfg.Provider {
case "openai":
    return NewOpenAIClient(cfg), nil
case "dashscope":
    return NewDashScopeClient(cfg), nil
default:
    return nil, fmt.Errorf("不支持的 AI 提供商: %s (支持: openai, dashscope)", cfg.Provider)
}
```

### 配置文件更新

- `config.yaml` - 更新注释说明
- `config.example.yaml` - 更新示例配置
- `config/deepseek.yaml` - 更新 provider 为 "openai"
- `config/README.md` - 更新文档说明

## 影响范围

### 需要手动更新的文件

如果你的配置文件使用了以下 provider 值，需要手动更新：
- `provider: "deepseek"` → `provider: "openai"`
- `provider: "custom"` → `provider: "openai"`

### 不受影响的功能

- API Key 加密/解密
- 代码审核逻辑
- 报告生成
- GUI 界面
- SVN 集成

## 优势

1. **代码更简洁**
   - 减少重复代码
   - 降低维护成本
   - 提高代码可读性

2. **配置更清晰**
   - 通过 base_url 明确区分服务
   - 减少配置选项的困惑
   - 更容易理解和使用

3. **扩展性更好**
   - 任何 OpenAI 兼容服务都可以直接使用
   - 不需要为每个服务添加新的 provider
   - 支持本地部署和自定义服务

4. **向后兼容**
   - 只需修改 provider 字段
   - 其他配置保持不变
   - 迁移成本低

## 常见问题

### Q: 为什么要移除 deepseek 提供商？

A: DeepSeek 完全兼容 OpenAI API 协议，使用 `provider: "openai"` 配合 DeepSeek 的 base_url 即可。保留单独的提供商会增加代码复杂度，但没有实际功能差异。

### Q: 我的旧配置还能用吗？

A: 旧配置需要手动更新 provider 字段。程序会提示 "不支持的 AI 提供商"，并列出支持的提供商列表。

### Q: 如何快速迁移？

A: 使用文本编辑器的查找替换功能：
- 查找：`provider: "deepseek"`
- 替换：`provider: "openai"`

### Q: DashScope 有两种使用方式吗？

A: 是的：
1. **兼容模式**：`provider: "openai"` + 兼容模式 URL
2. **应用模式**：`provider: "dashscope"` + 应用 ID

## 相关文档

- [提供商配置说明.md](./提供商配置说明.md) - 详细的提供商配置指南
- [DashScope集成说明.md](./DashScope集成说明.md) - DashScope 完整文档
- [config/README.md](./config/README.md) - 配置文件目录说明

## 技术支持

如有问题或建议，请查看相关文档或提交 Issue。
