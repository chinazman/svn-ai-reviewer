# 按钮状态控制说明

## 问题描述

审核按钮在点击后会显示"审核中"，但2秒后就恢复成"开始审核"，而实际审核还在进行中。

## 原因分析

之前的实现使用固定的2秒延迟来恢复按钮：
```javascript
setTimeout(() => {
    reviewBtn.disabled = false;
    reviewBtn.textContent = '开始审核';
}, 2000);
```

但审核通常需要更长时间（几十秒甚至几分钟），所以按钮过早恢复了。

## 解决方案

通过SSE消息来控制按钮状态，而不是固定延迟。

### 1. 在log函数中监听完成消息

```javascript
function log(message) {
    const logArea = document.getElementById('logArea');
    const timestamp = new Date().toLocaleTimeString();
    logArea.textContent += `[${timestamp}] ${message}\n`;
    logArea.scrollTop = logArea.scrollHeight;
    
    // 检查是否是审核完成的消息
    if (message.includes('所有文件审核完成')) {
        const reviewBtn = document.getElementById('reviewBtn');
        if (reviewBtn) {
            reviewBtn.disabled = false;
            reviewBtn.textContent = '开始审核';
        }
    }
}
```

### 2. 修改startReview函数

```javascript
async function startReview() {
    const reviewBtn = document.getElementById('reviewBtn');
    reviewBtn.disabled = true;
    reviewBtn.innerHTML = '<span class="loading"></span> 审核中...';
    
    try {
        const response = await fetch('/api/review', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ... })
        });
        
        const data = await response.json();
        if (data.error) {
            log('❌ ' + data.error);
            // 出错时立即恢复按钮
            reviewBtn.disabled = false;
            reviewBtn.textContent = '开始审核';
        }
        // 成功时不恢复按钮，等待SSE消息
    } catch (error) {
        log('❌ 请求失败: ' + error.message);
        // 出错时立即恢复按钮
        reviewBtn.disabled = false;
        reviewBtn.textContent = '开始审核';
    }
}
```

## 工作流程

### 正常流程

1. **用户点击"开始审核"**
   ```
   按钮状态: 禁用 + "审核中..."
   ```

2. **发送审核请求**
   ```
   POST /api/review
   响应: { "success": true, "message": "审核已开始" }
   ```

3. **审核在后台进行，SSE实时发送日志**
   ```
   [14:30:15] 开始审核 2 个文件...
   [14:30:16] [1/2] 正在审核: src/Main.java
   [14:30:20]   ✅ 审核完成
   [14:30:21] [2/2] 正在审核: src/Utils.java
   [14:30:25]   ✅ 审核完成
   [14:30:26] 正在生成HTML报告...
   [14:30:27] ✅ 报告已生成
   [14:30:27] 所有文件审核完成！  ← 触发按钮恢复
   ```

4. **收到"所有文件审核完成"消息**
   ```
   按钮状态: 启用 + "开始审核"
   ```

### 错误流程

1. **用户点击"开始审核"**
   ```
   按钮状态: 禁用 + "审核中..."
   ```

2. **发送审核请求失败**
   ```
   POST /api/review
   响应: { "error": "配置文件未加载" }
   ```

3. **立即恢复按钮**
   ```
   按钮状态: 启用 + "开始审核"
   ```

## 优势

### 1. 准确的状态控制
- ✅ 按钮状态与实际审核状态同步
- ✅ 不会过早恢复
- ✅ 不会一直禁用

### 2. 更好的用户体验
- ✅ 用户知道审核正在进行
- ✅ 用户知道何时可以再次审核
- ✅ 清晰的状态反馈

### 3. 错误处理
- ✅ 出错时立即恢复按钮
- ✅ 用户可以重试
- ✅ 不会卡住界面

## 关键消息

后端发送的关键消息：
```go
s.sendLog("所有文件审核完成！")
```

前端监听的关键字：
```javascript
if (message.includes('所有文件审核完成'))
```

## 适用场景

### 本地模式
- ✅ 已实现
- ✅ 监听"所有文件审核完成"

### 在线模式
- ✅ 已实现
- ✅ 监听"所有文件审核完成"

## 测试步骤

### 1. 正常审核
1. 点击"开始审核"
2. 观察按钮变为"审核中..."且禁用
3. 观察日志实时更新
4. 等待审核完成
5. 观察按钮恢复为"开始审核"且启用

### 2. 错误处理
1. 不加载配置文件
2. 点击"开始审核"
3. 观察按钮变为"审核中..."
4. 收到错误消息
5. 观察按钮立即恢复

### 3. 长时间审核
1. 选择多个文件
2. 点击"开始审核"
3. 观察按钮保持"审核中..."状态
4. 等待所有文件审核完成（可能几分钟）
5. 观察按钮在收到完成消息后恢复

## 注意事项

### 1. 消息格式
确保后端发送的消息包含"所有文件审核完成"文本：
```go
s.sendLog("所有文件审核完成！")
```

### 2. 错误恢复
所有错误情况都要恢复按钮：
```javascript
if (data.error) {
    reviewBtn.disabled = false;
    reviewBtn.textContent = '开始审核';
}
```

### 3. 网络问题
如果SSE连接断开，按钮可能不会恢复。可以考虑添加超时机制：
```javascript
// 可选：添加超时保护（例如10分钟）
setTimeout(() => {
    if (reviewBtn.disabled) {
        reviewBtn.disabled = false;
        reviewBtn.textContent = '开始审核';
        log('⚠️ 审核超时，请检查日志');
    }
}, 600000); // 10分钟
```

## 总结

通过SSE消息控制按钮状态：
- ✅ 点击时：禁用按钮，显示"审核中..."
- ✅ 审核中：保持禁用状态
- ✅ 完成时：收到SSE消息后恢复按钮
- ✅ 出错时：立即恢复按钮

这样确保按钮状态与实际审核状态完全同步。

---

**版本**: 1.4.1  
**更新日期**: 2024-01-15  
**状态**: ✅ 已修复
