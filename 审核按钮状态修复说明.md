# 审核按钮状态修复说?

## Bug 描述

审核完成并弹出报告后?开始审?按钮仍然显示?审核?.."状态，没有恢复到可用状态?

## 问题原因

### 1. 递归调用问题

原代码在检测到 `REPORT_URL:` 消息时，会调?`log('?已在新标签页打开报告')`，导致递归调用 `log()` 函数?

```javascript
// 问题代码
if (message.startsWith('REPORT_URL:')) {
    const reportURL = message.substring('REPORT_URL:'.length);
    window.open(reportURL, '_blank');
    log('?已在新标签页打开报告');  // ?递归调用
}
```

### 2. 按钮状态恢复时机不?

按钮状态只在检测到"所有文件审核完?消息时才恢复，但实际上报告已经打开了?

```javascript
// 原代?
if (message.includes('所有文件审核完?)) {
    // 恢复按钮状?
}
```

## 修复方案

### 1. 避免递归调用

直接将日志消息添加到日志区域，而不是调?`log()` 函数?

```javascript
// 修复?
if (message.startsWith('REPORT_URL:')) {
    const reportURL = message.substring('REPORT_URL:'.length);
    window.open(reportURL, '_blank');
    // 直接添加到日志区域，避免递归调用
    const timestamp2 = new Date().toLocaleTimeString();
    logArea.textContent += `[${timestamp2}] ?已在新标签页打开报告\n`;
    logArea.scrollTop = logArea.scrollHeight;
}
```

### 2. 在打开报告时恢复按钮状?

当检测到 `REPORT_URL:` 消息时，立即恢复按钮状态?

```javascript
// 修复?
if (message.includes('所有文件审核完?) || message.startsWith('REPORT_URL:')) {
    const reviewBtn = document.getElementById('reviewBtn');
    if (reviewBtn) {
        reviewBtn.disabled = false;
        reviewBtn.textContent = '开始审?;
    }
}
```

## 修复效果

### 修复?

```
1. 用户点击"开始审?
2. 按钮变为"审核?.."并禁?
3. 审核完成，报告打开
4. 按钮仍然显示"审核?.."  ?
5. 用户无法再次审核
```

### 修复?

```
1. 用户点击"开始审?
2. 按钮变为"审核?.."并禁?
3. 审核完成，报告打开
4. 按钮恢复?开始审?并启? ?
5. 用户可以继续审核其他文件
```

## 代码变更

### 本地模式 (gui/templates/index.html)

```javascript
function log(message) {
    const logArea = document.getElementById('logArea');
    const timestamp = new Date().toLocaleTimeString();
    logArea.textContent += `[${timestamp}] ${message}\n`;
    logArea.scrollTop = logArea.scrollHeight;
    
    // 检查是否是报告URL消息
    if (message.startsWith('REPORT_URL:')) {
        const reportURL = message.substring('REPORT_URL:'.length);
        window.open(reportURL, '_blank');
        // 直接添加到日志区域，避免递归调用
        const timestamp2 = new Date().toLocaleTimeString();
        logArea.textContent += `[${timestamp2}] ?已在新标签页打开报告\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }
    
    // 检查是否是审核完成的消息或报告URL消息（恢复按钮状态）
    if (message.includes('所有文件审核完?) || message.startsWith('REPORT_URL:')) {
        const reviewBtn = document.getElementById('reviewBtn');
        if (reviewBtn) {
            reviewBtn.disabled = false;
            reviewBtn.textContent = '开始审?;
        }
    }
}
```

### 在线模式 (gui/templates/online.html)

同样的修复方式?

## 测试验证

### 测试步骤

1. 启动审核工具
2. 选择文件并点?开始审?
3. 等待审核完成
4. 观察报告是否自动打开
5. 检查按钮是否恢复为"开始审?状?
6. 尝试再次点击按钮进行审核

### 预期结果

- ?报告自动在新标签页打开
- ?日志显示"已在新标签页打开报告"
- ?按钮恢复?开始审?状?
- ?按钮可以再次点击
- ?可以继续进行新的审核

## 相关功能

### SSE 日志?

审核过程通过 SSE (Server-Sent Events) 实时推送日志消息：

```
开始审?2 个文?..
[1/2] 正在审核: file1.go
  ?审核完成
[2/2] 正在审核: file2.go
  ?审核完成
正在生成HTML报告...
?报告已生? F:/path/to/report.html
REPORT_URL:http://localhost:8080/reports/report-xxx.html
所有文件审核完成！
```

### 按钮状态管?

按钮有三种状态：

1. **初始状?*：`开始审核` (enabled)
2. **审核?*：`审核?..` (disabled)
3. **完成状?*：`开始审核` (enabled)

## 注意事项

1. **双重触发**：按钮状态会在两个时机恢复：
   - 收到 `REPORT_URL:` 消息?
   - 收到"所有文件审核完?消息?
   
   这是为了确保即使某个消息丢失，按钮也能恢复?

2. **日志顺序**：修复后的日志顺序：
   ```
   REPORT_URL:http://...
   ?已在新标签页打开报告
   所有文件审核完成！
   ```

3. **浏览器兼容?*：`window.open()` 可能被浏览器的弹窗拦截器阻止，需要用户允许弹窗?

## 未来改进

- [ ] 添加审核进度?
- [ ] 显示审核剩余时间
- [ ] 支持取消审核操作
- [ ] 添加审核历史记录
- [ ] 支持批量审核队列
